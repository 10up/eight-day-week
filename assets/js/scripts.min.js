!function(a,b){"use strict";var c,d={_data:{_ajax_nonce:EDW_Vars.nonce},_send:wp.ajax.send,_post:wp.ajax.post,post:function(a,c,d,e){b.extend(c,this._data);var f=this._post(a,c);return this.locker(f,d,e),this.suhcurity(f),f},locker:function(a,b,d){c.lock_input(b,d),a.always(function(){c.release_input(b,d)})},suhcurity:function(a){var b=this;a.always(function(a){"object"==typeof a&&"undefined"!=typeof a._ajax_nonce?b.set_nonce(a._ajax_nonce):c.flash_error("Whoops! Looks like this page has been sitting for a while. Try refreshing!")})},set_nonce:function(a){this._data._ajax_nonce=a},send_get:function(a,c,d,e){b.extend(c,this._data);var f={type:"GET",data:c},g=this._send(a,f);return this.locker(g,d,e),this.suhcurity(g),g}};c={$error_msg:b("#pi-section-error"),$metabox_wrap:b(".meta-box-sortables"),$postbox_wrap:b("#postbox-container-2"),add_progress_indicator:function(a){a.after(EDW_Vars.progress_img)},remove_progress_indicator:function(){b(".edw-loading").remove()},handlers:function(){this.$postbox_wrap.on("keypress",'input[type="text"]',this.submit_to_buttons)},get_inputs:function(a,c){var d,e={button:!1,input:!1};return d="undefined"==typeof c&&"undefined"!=typeof a?a.siblings(".button"):c instanceof b?b(c):c,"undefined"!=typeof d&&d.length&&(e.button=d),"undefined"!=typeof a&&a.length&&(e.input=a),e},lock_input:function(a,b){var d=this.get_inputs(a,b);d.button&&d.button.hide(),d.input&&(d.input.attr("disabled","disabled"),d.input.addClass("locked"),c.add_progress_indicator(d.input)),!d.input&&d.button&&c.add_progress_indicator(d.button)},release_input:function(a,b){var d=this.get_inputs(a,b);d.input&&(c.remove_progress_indicator(d.input),d.input.removeAttr("disabled"),d.input.removeClass("locked")),!d.input&&d.button&&c.remove_progress_indicator(d.button),d.button&&d.button.show()},submit_to_buttons:function(a){if(13===a.which){a.preventDefault();var c=b(this).siblings("button");return c.length&&c.click(),!1}},flash_error:function(a){this.$error_msg.text(a),this.$error_msg.show().delay(4500).fadeOut()}},c.handlers();var e;e={$section_ids:b("#pi-section-ids"),$titles:b('[id^="pi-sections-box"].postbox .hndle span'),$pi_section_name:b("#pi-section-name"),init:function(){var a=this;this.handlers(),b(document).ready(function(){var c=b.proxy(a.ready,a);c()})},ready:function(){this.$titles.attr("contenteditable","true"),this.$titles.attr("title","Click to edit section name"),c.$metabox_wrap.sortable({cancel:":input,button,[contenteditable]"}),b('[id^="pi-sections-box"].postbox .hndle').unbind(),this.set_initial_title_data()},handlers:function(){var a=this;b("#pi-section-add").on("click",function(c){c.preventDefault();var d=b.proxy(a.toggle_section_add_inputs,a);d()}),b("#pi-section-add-confirm").on("click",function(c){c.preventDefault();var d=b.proxy(a.add_section,a);d()}),c.$metabox_wrap.on("click",".postbox.js .handlediv",this.toggle_handler),c.$metabox_wrap.on("blur",".postbox .hndle span",function(){var c=b.proxy(a.check_title_change,a,b(this));c()}),c.$metabox_wrap.on("keypress",".postbox .hndle span",a.map_enter_to_blur),c.$metabox_wrap.on("click",".pi-section-delete a",function(c){c.preventDefault();var d=b.proxy(a.delete_section,a,b(this));d()})},destroy_sortable:function(){c.$metabox_wrap.sortable("destroy")},set_initial_title_data:function(){this.$titles.each(this.set_title_data)},check_title_change:function(a){var b=this.get_existing_title(a),c=this.get_new_title(a);b!==c&&this.title_changed(a,c)},map_enter_to_blur:function(a){13===a.which&&(a.preventDefault(),a.stopImmediatePropagation(),b(this).blur())},title_changed:function(a,d){var e=this,f=a.parents(".postbox").find(".section_id").val(),g=this.save_section_title(d,f,a);this.set_title_lock(a),g.fail(function(d){var f=b.proxy(e.reset_title,e,a);f(),c.flash_error(d.message)}),g.done(function(c){var d=b.proxy(e.set_title_data,e,a);d()}),g.always(function(){var c=b.proxy(e.release_title_lock,e,a);c()})},release_title_lock:function(a){a.attr("contenteditable",!0)},set_title_lock:function(a){a.attr("contenteditable",!1)},reset_title:function(a){a.text(a.data("title"))},save_section_title:function(a,b,c,e){return d.post("pp-update-section-title",{title:a,post_id:b},c,e)},get_new_title:function(a){return a[0].textContent},get_existing_title:function(a){return a.data("title")},set_title_data:function(){b(this).data("title",b(this)[0].textContent)},delete_section:function(b){if(a.confirm("Are you sure you want to delete this section?")){var c=b.parents(".postbox"),d=c.find(".section_id").val(),e=this.$section_ids.val().split(","),f=e.indexOf(d);f>-1&&(e.splice(f,1),this.$section_ids.val(e.join(","))),c.remove()}},add_section:function(){var a=this,b=this.$pi_section_name.val();if(!b.length)return this.flash_error("Please enter a section name.");var d=a.create_section(b,this.$pi_section_name);d.fail(function(a){c.flash_error(a.message)}),d.done(function(d){var e=a.$insert_section(b,d.section_id);a.clear_add_input(),a.toggle_section_add_inputs(),a.save_metabox_order(),c.$postbox_wrap.trigger("pp-section-added",e,d.section_id)})},save_metabox_order:function(){"undefined"!=typeof postboxes&&postboxes.save_order("print-issue")},create_section:function(a,b,c){return d.post("pp-create-section",{name:a},b,c)},$insert_section:function(a,c){var d=b('[id^="pi-sections-template"].postbox').first().clone();return d.attr("id","pi-sections-box-"+c),d.find(".hndle > span").text(a).attr("contenteditable","true"),d.addClass("js"),d.removeClass("hide-if-js"),d.find(".section_id").val(c),d.find(".pi-article-ids").attr("name","pi-article-ids["+c+"]"),b("#normal-sortables").append(d),this.append_section_id(c),d},append_section_id:function(a){var b=this.$section_ids.val();b.length&&(b+=","),b+=a,this.$section_ids.val(b)},toggle_handler:function(){if("undefined"!=typeof postboxes){var a=b(this).parent(".postbox"),c=a.attr("id");a.toggleClass("closed"),postboxes.save_state("print-issue"),c&&(!a.hasClass("closed")&&b.isFunction(postboxes.pbshow)?postboxes.pbshow(c):a.hasClass("closed")&&b.isFunction(postboxes.pbhide)&&postboxes.pbhide(c)),b(document).trigger("postbox-toggled",a)}},toggle_section_add_inputs:function(){this.toggle_add_info(),this.toggle_add_section()},toggle_add_info:function(){b("#pi-section-add-info").toggle()},toggle_add_section:function(){b("#pi-section-add").toggle()},clear_add_input:function(){b("#pi-section-name").val("")}},e.init();var f;f={sortable_container:"#postbox-container-2",$bulk_article_status_select:b("#bulk-action-selector-top"),article_search_cache:{},init:function(){var a=this;this.handlers(),b(document).ready(function(){var c=b.proxy(a.ready,a);c()})},handlers:function(){var a=this;c.$metabox_wrap.on("click",".pi-article-add",function(c){c.preventDefault();var d=b.proxy(a.toggle_article_add_inputs,a,b(this));d()}),c.$metabox_wrap.on("click",".pi-article-search",function(c){c.preventDefault();var d=b.proxy(a.search_for_articles,a,b(this));d()}),c.$metabox_wrap.on("click",".pi-article-result-confirm",function(c){c.preventDefault();var d=b.proxy(a.add_article,a,b(this));d()}),c.$metabox_wrap.on("click",".pi-article-remove",function(c){c.preventDefault();var d=b.proxy(a.remove_article,a,b(this));d()}),b("#bulk-edit-article-status-submit").click(function(c){c.preventDefault();var d=b.proxy(a.edit_checked_article_status,a,b(this));d()}),b("#bulk-edit-article-status-apply-all").click(function(c){c.preventDefault();var d=b.proxy(a.edit_all_article_status,a,b(this));d()}),c.$postbox_wrap.on("pp-section-added",function(c,d){var e=b.proxy(a.refresh_autocomplete,a,d);e()})},ready:function(){this.init_sortable(),this.init_autocomplete()},init_autocomplete:function(){var a=this;b(".pi-article-title").autocomplete({source:function(c,d){var e=c.term;if(e in a.article_search_cache)return void d(a.article_search_cache[e]);var f=a.get_articles(e);f.done(function(c){var f=b.makeArray(c.articles);a.article_search_cache[e]=f,d(f)}),f.fail(function(a){d([])})},select:function(c,d){c.preventDefault(),a.add_article(b(this),d.item.value),b(this).autocomplete("close"),b(this).val("")}})},refresh_autocomplete:function(a){b('[id^="pi-sections-box"].postbox').not(a).children(".pi-article-title").autocomplete("destroy"),this.init_autocomplete()},init_sortable:function(){var a=this,c=b(this.sortable_container);"undefined"==typeof c.sortable("instance")&&c.length?c.sortable({placeholder:"sortable-placeholder",items:'.postbox[id^="pi-sections-box"] tr',containment:"parent",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,helper:"clone",opacity:.65,update:function(c,d){var e=b.proxy(a.update_sortable,a,c,d);e()}}):c.length&&c.sortable("refresh")},update_sortable:function(a,c){var d=c.item,e=d.parents(".postbox"),f=d.siblings("tr").addBack().map(function(){return b(this).data("article-id")}).get();this.set_article_ids(e,f)},refresh_sortable:function(a){var c=b(this.sortable_container);"undefined"!=typeof c.sortable("instance")&&this.destroy_sortable(),this.init_sortable()},destroy_sortable:function(){b(this.sortable_container).sortable("destroy")},set_article_ids:function(a,b,c){var d=c||a.find(".pi-article-ids");d.val(b.join(","))},flash_error:function(a,b){a.find(".pi-error-msg").text(b),a.find(".pi-error-msg").show().delay(4500).fadeOut()},toggle_article_add_inputs:function(a){var b=(a.parents(".postbox"),a.siblings(".pi-articles"),a.siblings(".pi-article-add-info"));a.toggle(),b.toggle()},get_articles:function(a,b,c){return d.send_get("pp-get-articles",{title:a},b,c)},add_article:function(a,b){var c=this,d=a.parents(".postbox");if(b){if(this.article_exists_in_section(b,"",d))return void c.flash_error(d,"Whoops! You've already added that article to this section.");var e=this.get_article_row(b,a);e.done(function(a){c.$insert_article(d,a),c.add_article_id(d,b)}),e.fail(function(a){c.flash_error(d,a.message)})}},$insert_article:function(a,c){var d=a.find(".wp-list-table tbody"),e=b(c.html);d.append(e),this.refresh_sortable(a)},edit_article_meta:function(a,b){for(var c in b){var d=a.children("td.column-"+c);d.length&&(this.is_html(b[c])?d.html(b[c]):d.text(b[c]))}},is_html:function(a){var c=b.parseHTML(a),d=!1;for(var e in c)if("#text"!==c[e].nodeName){d=!0;break}return d},add_article_id:function(a,b){var c=a.find(".pi-article-ids"),d=this.get_article_ids(c,a)||[];d.indexOf(b)>-1||(d.push(parseInt(b)),this.set_article_ids(a,d,c))},get_index_of_article_id:function(a,b,c){var d=this.get_article_ids(b,c)||[];return d.indexOf(parseInt(a))},article_exists_in_section:function(a,b,c){return this.get_index_of_article_id(a,b,c)>-1},remove_article_id:function(a,b){var c=a.find(".pi-article-ids"),d=this.get_article_ids(c);if(d){var e=d.indexOf(parseInt(b));return e>-1?(d.splice(e,1),this.set_article_ids(a,d,c),!0):!1}},get_article_ids:function(a,b){!a.length&&"undefined"!=typeof b&&b.length&&(a=b.find(".pi-article-ids"));var c=a.val();return c.length?(c=c.split(","),c.map(function(a){return parseInt(a,10)})):!1},remove_article:function(a){var b=a.parents(".postbox"),c=a.parents("tr"),d=a.data("article-id");c.remove(),this.refresh_sortable(b),this.remove_article_id(b,d)},get_article_row:function(a,b,c){return d.send_get("pp-get-article-row",{article_id:a},b,c)},edit_checked_article_status:function(a){var c=b("input.article-status:checked");this.edit_supplied_article_status(c)},edit_all_article_status:function(c){if(a.confirm("Are you sure you want to apply this status to all articles in this issue?")){var d=b('tr[data-article-id!="0"] input.article-status');this.edit_supplied_article_status(d)}},edit_supplied_article_status:function(a){var b=this,d=this.$bulk_article_status_select.val(),e=this.$bulk_article_status_select.children("option:selected").text(),f=a.map(function(){return this.value}).get();if(!f.length)return void c.flash_error("Check some article boxes first!");f=f.join(",");var g=this.edit_article_status(d,f,this.$bulk_article_status_select);g.done(function(){b.add_new_article_statuses(e,a)}),g.fail(function(a){c.flash_error(a.message)})},edit_article_status:function(a,b,c,e){return d.post("pp-bulk-edit-article-statuses",{status:a,checked_articles:b},c,e)},add_new_article_statuses:function(a,c){var d=this;c.each(function(){d.edit_article_meta(b(this).parents("tr"),{article_status:a})})}},f.init();var g={init:function(){this.handlers()},handlers:function(){b(document).ready(this.ready),b(document).ready(this.rov_view)},ready:function(){var a=b("#submitdiv");a.removeClass("postbox"),a.children(".hndle").children("span").text("Issue Date");var c=b("#major-publishing-actions");c.wrapInner('<div id="publishing-actions"></div>'),c.prepend('<h3 class="hndle">Actions</h3>')},rov_view:function(){(EDW_Vars.rov||!EDW_Vars.cuc_edit_print_issue)&&(f.destroy_sortable(),e.destroy_sortable(),b("#title").attr("disabled","disabled"))}};g.init();var h;h={$export_checked_button:b("#article-export-checked"),$export_all_button:b("#article-export-all"),init:function(){this.handlers()},handlers:function(){var a=this;this.$export_checked_button.click(function(c){var d=b.proxy(a.handle_article_export_checked,a,b(this),c);d()}),this.$export_all_button.click(function(c){var d=b.proxy(a.handle_article_export_all,a,b(this),c);d()})},handle_article_export_checked:function(a,c){c.preventDefault();var d=b("input.article-status:checked");this.export_supplied_articles(d,a)},handle_article_export_all:function(a,c){c.preventDefault();var d=b('tr[data-article-id!="0"] input.article-status');this.export_supplied_articles(d,a)},update_export_meta:function(a,b){return d.post("pp-article-export-update",{article_ids:a},void 0,b)},$update_export_meta:function(a,c){var d=f,e=a.map(function(){return b(this).parents("tr")});e.each(function(a,b){d.edit_article_meta(b,c)})},export_supplied_articles:function(a,d){var e=this,f=a.map(function(){return this.value}).get();if(!f.length)return void c.flash_error("Check some article boxes first!");f=f.join(",");var g=this.update_export_meta(f,d);g.done(function(b){e.$update_export_meta(a,b)});var h=b("<form />",{action:wp.ajax.settings.url,method:"post"});h.append(b("<input />",{type:"hidden",name:"article_ids",value:f})),h.append(b("<input />",{type:"hidden",name:"print_issue_id",value:b("#post_ID").val()})),h.append(b("<input />",{type:"hidden",name:"print_issue_title",value:b("#title").val()})),h.append(b("<input />",{type:"hidden",name:"_ajax_nonce",value:EDW_Vars.nonce})),h.append(b("<input />",{name:"action",type:"hidden",value:"pp-article-export"})),b("body").append(h),h.submit(),h.remove()}},h.init()}(this,jQuery);